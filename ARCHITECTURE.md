# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º—ã BotFeature

## üîÑ –°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã —Ç–æ—Ä–≥–æ–≤–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

```mermaid
graph TD
    A[–ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã] --> B[–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã]
    B --> C[–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∏–¥-—Å–µ—Ç–∫–∏]
    C --> D[–†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ –Ω–∞ –±–∏—Ä–∂–µ]
    D --> E[–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫]
    E --> F{–û—Ä–¥–µ—Ä –∏—Å–ø–æ–ª–Ω–µ–Ω?}
    F -->|–ù–µ—Ç| E
    F -->|–î–∞| G[–°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞]
    G --> H{–¢–ü –∏—Å–ø–æ–ª–Ω–µ–Ω?}
    H -->|–ù–µ—Ç| E
    H -->|–î–∞| I[–û—Ç–º–µ–Ω–∞ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ—Ä–¥–µ—Ä–æ–≤]
    I --> J[–ü–∞—É–∑–∞ 60 —Å–µ–∫—É–Ω–¥]
    J --> B
```

## üíº –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```
üèóÔ∏è BotFeature
‚îú‚îÄ‚îÄ üéØ Main Process (main.py)
‚îÇ   ‚îú‚îÄ‚îÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ Celery –∑–∞–¥–∞—á
‚îÇ   ‚îî‚îÄ‚îÄ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞
‚îÇ
‚îú‚îÄ‚îÄ üîß Celery Workers
‚îÇ   ‚îú‚îÄ‚îÄ start_master_trading
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–Ω–µ—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ start_symbol_trading  
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–ª–µ—á–∞/–º–∞—Ä–∂–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∏–¥-—Å–µ—Ç–∫–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ track_symbol_continuously
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –æ—Ä–¥–µ—Ä–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
‚îÇ   ‚îî‚îÄ‚îÄ restart_symbol_after_delay
‚îÇ       ‚îî‚îÄ‚îÄ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –¢–ü
‚îÇ
‚îú‚îÄ‚îÄ üîå Bitget API Client
‚îÇ   ‚îú‚îÄ‚îÄ Rate Limiting (100 req/min)
‚îÇ   ‚îú‚îÄ‚îÄ Connection Pooling  
‚îÇ   ‚îú‚îÄ‚îÄ Error Handling
‚îÇ   ‚îî‚îÄ‚îÄ Automatic Reconnection
‚îÇ
‚îú‚îÄ‚îÄ üíæ Database Layer (SQLite)
‚îÇ   ‚îú‚îÄ‚îÄ limit_orders - –∞–∫—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç–Ω—ã–µ –æ—Ä–¥–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ take_profit_orders - –æ—Ä–¥–µ—Ä–∞ –¢–ü
‚îÇ   ‚îî‚îÄ‚îÄ users - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã  
‚îÇ
‚îú‚îÄ‚îÄ üì® Notification System
‚îÇ   ‚îú‚îÄ‚îÄ Kafka Producer ‚Üí Topics
‚îÇ   ‚îú‚îÄ‚îÄ Kafka Consumer ‚Üí Telegram Bot
‚îÇ   ‚îî‚îÄ‚îÄ Admin Notifications
‚îÇ
‚îî‚îÄ‚îÄ üõ°Ô∏è Security & Utils
    ‚îú‚îÄ‚îÄ Encryption (Fernet)
    ‚îú‚îÄ‚îÄ Rate Limiting
    ‚îî‚îÄ‚îÄ Logging System
```

## üìä –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```mermaid
sequenceDiagram
    participant M as Main Process
    participant C as Celery Worker
    participant B as Bitget API
    participant D as Database
    participant K as Kafka
    participant T as Telegram Bot

    M->>C: –ó–∞–ø—É—Å–∫ —Ç–æ—Ä–≥–æ–≤–ª–∏ (CRV/USDT, 10 USDT)
    C->>B: –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É CRV
    B-->>C: $0.50
    C->>C: –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –≥—Ä–∏–¥-—Å–µ—Ç–∫—É (15 –æ—Ä–¥–µ—Ä–æ–≤)
    
    loop –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ä–¥–µ—Ä–æ–≤
        C->>B: –°–æ–∑–¥–∞—Ç—å –ª–∏–º–∏—Ç–Ω—ã–π –æ—Ä–¥–µ—Ä
        B-->>C: Order ID: 123456
        C->>D: –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ä–¥–µ—Ä –≤ –ë–î
        C->>K: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    end
    
    K->>T: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Å–æ–∑–¥–∞–Ω–∏–∏ –æ—Ä–¥–µ—Ä–æ–≤
    T->>T: –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É
    
    loop –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫
        C->>B: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ä–¥–µ—Ä–∞
        B-->>C: Status: filled
        C->>D: –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ –ë–î
        C->>B: –°–æ–∑–¥–∞—Ç—å —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –æ—Ä–¥–µ—Ä
        C->>K: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–∏
    end
    
    C->>B: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¢–ü
    B-->>C: –¢–ü –∏—Å–ø–æ–ª–Ω–µ–Ω
    C->>C: –û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ –æ—Ä–¥–µ—Ä–∞
    C->>C: –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
```

## üî¢ –ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å –≥—Ä–∏–¥-—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

### –†–∞—Å—á–µ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞:
```
available_amount = deposit_amount √ó leverage
available_amount = 10 USDT √ó 20 = 200 USDT

total_multiplier = Œ£(martingale_multiplier^i) for i in range(grid_levels)
total_multiplier = 1 + 1.3 + 1.69 + 2.197 + ... ‚âà 142.8

base_quantity = available_amount / (total_multiplier √ó current_price)
base_quantity = 200 / (142.8 √ó 0.50) ‚âà 2.8 CRV
```

### –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π —Å–µ—Ç–∫–∏:
```
current_price = $0.50
coverage_percent = 0.40
min_price = current_price √ó (1 - coverage_percent) = $0.30
price_step = (current_price - min_price) / (grid_levels - 1)
price_step = ($0.50 - $0.30) / 14 ‚âà $0.0143

–£—Ä–æ–≤–Ω–∏:
Level 0 (Market): $0.500 - 2.8 CRV
Level 1: $0.486 - 3.64 CRV  
Level 2: $0.471 - 4.73 CRV
...
Level 14: $0.300 - 400+ CRV
```

### –†–∞—Å—á–µ—Ç —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞:
```
–î–æ–ø—É—Å—Ç–∏–º –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 3 –æ—Ä–¥–µ—Ä–∞:
Order 1: 2.8 CRV –ø–æ $0.486 = $1.36
Order 2: 3.64 CRV –ø–æ $0.471 = $1.71  
Order 3: 4.73 CRV –ø–æ $0.457 = $2.16

total_quantity = 2.8 + 3.64 + 4.73 = 11.17 CRV
total_cost = $1.36 + $1.71 + $2.16 = $5.23
average_price = $5.23 / 11.17 = $0.468

take_profit_price = average_price √ó (1 + take_profit_percent)
take_profit_price = $0.468 √ó 1.02 = $0.477

–ü—Ä–∏–±—ã–ª—å = (11.17 √ó $0.477) - $5.23 = $0.106 (‚âà2%)
–î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞ = $0.106 / $10 = 1.06%
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã

### Redis Queues:
```
Queue 'trading': –ó–∞–ø—É—Å–∫ –Ω–æ–≤—ã—Ö —Ç–æ—Ä–≥–æ–≤—ã—Ö —Å–µ—Å—Å–∏–π
Queue 'tracking': –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ—Ä–¥–µ—Ä–æ–≤  
Queue 'restart': –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç–∞
Queue 'notifications': –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –∞–ª–µ—Ä—Ç—ã
```

### Celery Configuration:
```python
worker_prefetch_multiplier = 1      # –û–¥–∏–Ω —Ç–∞—Å–∫ –Ω–∞ –≤–æ—Ä–∫–µ—Ä
task_acks_late = True               # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
worker_max_tasks_per_child = 1000   # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞
task_soft_time_limit = 300          # –ú—è–≥–∫–∏–π –ª–∏–º–∏—Ç 5 –º–∏–Ω
task_time_limit = 600               # –ñ–µ—Å—Ç–∫–∏–π –ª–∏–º–∏—Ç 10 –º–∏–Ω
```

### Database Indexes:
```sql
-- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
CREATE INDEX idx_limit_orders_symbol_status ON limit_orders(symbol, status);
CREATE INDEX idx_tp_orders_symbol_status ON take_profit_orders(symbol, status);
CREATE INDEX idx_orders_created_at ON limit_orders(created_at);
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### API Keys Encryption:
```python
# –í—Å–µ API –∫–ª—é—á–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
from cryptography.fernet import Fernet

cipher = Fernet(ENCRYPTION_KEY)
encrypted_key = cipher.encrypt(api_key.encode())
# –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ encrypted_key
```

### Rate Limiting Strategy:
```python
class RateLimiter:
    max_requests_per_minute = 100
    max_concurrent_requests = 5
    backoff_strategy = "exponential"
    retry_attempts = 3
```

## üìà –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

1. **–¢–æ—Ä–≥–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
   - –ü—Ä–æ—Ü–µ–Ω—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –æ—Ä–¥–µ—Ä–æ–≤
   - –°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å —Å –¢–ü
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–æ–≤ –≤ –¥–µ–Ω—å

2. **–°–∏—Å—Ç–µ–º–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - Latency API –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ failed –∑–∞–ø—Ä–æ—Å–æ–≤
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ Redis
   - –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–µ–π Celery

3. **–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**
   - –û–±—â–∏–π P&L –∑–∞ –ø–µ—Ä–∏–æ–¥
   - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
   - Sharpe ratio —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
   - –ö–æ–º–∏—Å—Å–∏–∏ –±–∏—Ä–∂–∏

### –ê–ª–µ—Ä—Ç—ã –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:
```python
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:
- API –∫–ª—é—á–∏ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã
- –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç—É  
- –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API
- –°–∏—Å—Ç–µ–º–Ω—ã–µ –æ—à–∏–±–∫–∏ > 5 –ø–æ–¥—Ä—è–¥
- –ü—Ä–æ—Å–∞–¥–∫–∞ > 20% –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞
- –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ > 10 –º–∏–Ω—É—Ç
```

## üîß –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è API –∑–∞–ø—Ä–æ—Å–æ–≤:
- **Batch requests**: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫ –æ—Ä–¥–µ—Ä–æ–≤
- **Caching**: –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –Ω–∞ 1-2 —Å–µ–∫—É–Ω–¥—ã
- **Connection pooling**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
- **Graceful degradation**: –†–∞–±–æ—Ç–∞ –ø—Ä–∏ —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–±–æ—è—Ö API

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
- **Connection pooling**: –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –¥–ª—è SQLite
- **Batch updates**: –ì—Ä—É–ø–ø–æ–≤—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- **–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã**: –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
- **Cleanup —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π**: –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:
- **Horizontal scaling**: –ù–µ—Å–∫–æ–ª—å–∫–æ Celery –≤–æ—Ä–∫–µ—Ä–æ–≤
- **Queue partitioning**: –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á  
- **Redis clustering**: –î–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫
- **Database sharding**: –ü—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—Ä–¥–µ—Ä–æ–≤

---

*–≠—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω—É—é, –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é —Ç–æ—Ä–≥–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–∏–±—ã–ª—å–Ω–æ—Å—Ç—å—é.*
